<div
  class="modal fade"
  id="addCreateTemplate"
  tabindex="-1"
  aria-labelledby="addCreateTemplateLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <label id="hdnId" class="d-none"></label>
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCreateTemplateLabel">Create Template</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="section-container">
        <div class="section-header">Diagnosis - Investigation - Plan</div>
        <div class="section-body">
          <div id="diagnosis-section"></div>
        </div>
      </div>

      <script>
        $("#diagnosis-section").load("./sections/diagnosis-section.html");
      </script>

      <div class="section-container">
        <div class="section-header">Chief Complaint</div>
        <div class="section-body">
          <div id="chief-complaint-section"></div>
        </div>
      </div>

      <script>
        $("#chief-complaint-section").load(
          "./sections/chief-complaint-section.html"
        );
      </script>

      <div class="modal-body">
        <form id="addDiagnosisForm">
          <div class="section-container">
            <div class="section-header">Medicine</div>
            <div class="section-body">
              <div id="medicine-section"></div>
            </div>
          </div>

          <script>
            $("#medicine-section").load("./sections/medicine-section.html");
          </script>
        </form>
      </div>

      <div class="section-container">
        <div class="section-header">Rehabilitation Aids</div>
        <div class="section-body">
          <div id="rehabilitation-aids-section"></div>
        </div>
      </div>

      <script>
        $("#rehabilitation-aids-section").load(
          "./sections/rehabilitation-aids-section.html"
        );
      </script>

      <div class="modal-body">
        <form id="addDiagnosisForm">
          <div class="section-container">
            <div class="section-header">Patient Instructions</div>
            <div class="section-body">
              <div id="patient-instruction-section"></div>
            </div>
          </div>

          <script>
            $("#patient-instruction-section").load(
              "./sections/patient-instruction-section.html"
            );
          </script>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="createTemplate">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {
    $("#addCreateTemplate").modal("show");
    $(".modal-dialog").addClass("width-100");

    $("#createTemplate").on("click", async function () {
      const templateData = await gettemplateData();
      if (createTemplateValidated(templateData)) {
        createTemplateT(templateData);
      }
    });

    async function createTemplateT(templateData) {
      var id = $("#hdnId").html();
      createTemplate(id, templateData);
      $("#addCreateTemplate").modal("hide");
      loadPageContent(
        "diagnosis",
        "diagnosisTable",
        $("#diagnosisTable").DataTable().page()
      );
    }
    async function createTemplate(id, templateData) {
      const results = await window.electronAPI.createTemplate(
        id,
        JSON.stringify(templateData)
      );
      common.showSavedSuccessfullyMessage();
    }

    function createTemplateValidated(templateData) {
      if (!medicineValidated(templateData)) {
        return false;
      }
      return true;
    }

    function medicineValidated(templateData) {
      let isValid = true;
      templateData.patientInformation.selectedMedicines.forEach(
        (medicine, index) => {
          if (isValid) {
            const error = {};

            // Check if medicine name is empty
            if (!medicine.medicinename.trim()) {
              $.toast({
                heading: "Error",
                text: `Medicine name is required in ( ROW ${index + 1} )`,
                showHideTransition: "fade",
                icon: "error",
                position: "top-right",
              });
              isValid = false;
            }
          }
        }
      );

      return isValid;
    }

    async function init(id) {
      $("#hdnId").html(id);
      try {
        // Fetch the medicines associated with the diagnosis ID
        const result = await window.electronAPI.getCreateTemplateByDiagnosisIds(
          id.toString()
        );
        $("#divDiagnosisSection").hide();

        if (result && result.length > 0) {
          var templateData = JSON.parse(
            result[0].templateData
          ).patientInformation;

          // For each section, populate if data exists, otherwise add empty row
          if (
            templateData.complaintData &&
            templateData.complaintData.length > 0
          ) {
            populateAllComplaints(templateData.complaintData);
          } else {
            addNewComplaintRow();
          }

          if (
            templateData.selectedInvestigation &&
            templateData.selectedInvestigation.length > 0
          ) {
            populateInvestigation(
              templateData.selectedInvestigation,
              templateData.investigationMoreDetail
            );
          }

          if (
            templateData.selectedPlan &&
            templateData.selectedPlan.length > 0
          ) {
            populatePlan(templateData.selectedPlan);
          }

          if (
            templateData.selectedMedicines &&
            templateData.selectedMedicines.length > 0
          ) {
            populateAllMedicines(templateData.selectedMedicines);
          } else {
            addNewMedicineRow();
          }

          if (
            templateData.selectedRehabilitationAids &&
            templateData.selectedRehabilitationAids.length > 0
          ) {
            populateRehabilitationAids(templateData.selectedRehabilitationAids);
          } else {
            addNewRehabilitationAidRow();
          }

          if (
            templateData.selectedPatientInstructions &&
            templateData.selectedPatientInstructions.length > 0
          ) {
            populateAllPatientInstructions(
              templateData.selectedPatientInstructions
            );
          } else {
            addNewPatientInstructionRow();
          }
        } else {
          // If no template data exists at all, add empty rows for all sections
          addNewComplaintRow();
          addNewMedicineRow();
          addNewRehabilitationAidRow();
          addNewPatientInstructionRow();
        }
      } catch (error) {
        $.toast({
          heading: "Error",
          text: error,
          showHideTransition: "fade",
          icon: "error",
          position: "top-right",
        });
      }
    }

    // Helper functions for adding new rows
    function addNewComplaintRow() {
      var complaintRow = common.getChiefComplaintRow();
      complaintRow = $(complaintRow);
      complaintRow.find(".complaint-input").val("");
      complaintRow
        .find(".duration-select")
        .val(common.getSettings()[0].defaultcomplaintduration);
      complaintRow
        .find(".unit-select")
        .val(common.getSettings()[0].defaultcomplaintunit);
      $("#chiefComplaintsContainer tbody").append(complaintRow);
    }

    function addNewMedicineRow() {
      var medicineRow = common.getMedicineRow();
      medicineRow = $(medicineRow);
      $("#medicineContainer tbody").append(medicineRow);
    }

    function addNewRehabilitationAidRow() {
      var rehabilitationAidRow = common.getRehabilitationAidRow();
      rehabilitationAidRow = $(rehabilitationAidRow);
      $("#rehabilitationAidsContainer tbody").append(rehabilitationAidRow);
    }

    function addNewPatientInstructionRow() {
      var patientInstructionRow = common.getPatientInstructionRow();
      patientInstructionRow = $(patientInstructionRow);
      $("#patient-instructionContainer tbody").append(patientInstructionRow);
    }

    function populateAllComplaints(complaints) {
      if (complaints && complaints.length > 0) {
        // Clear existing rows before populating
        $("#chiefComplaintsContainer .complaint-row").remove();
        complaints.forEach((complaints, index) => {
          // For each medicine, either populate an existing row or add a new row
          if (index === 0) {
            populateChiefComplaintRow(complaints); // Populate the first row
          } else {
            const newRowHtml = common.getChiefComplaintRow(); // Create a new row
            $("#chiefComplaintsContainer tbody").append(newRowHtml);
            populateChiefComplaintRow(
              complaints,
              $("#chiefComplaintsContainer .complaint-row").last()
            ); // Populate the new row
          }
        });
      }
    }
    function populateChiefComplaintRow(complaints, row) {
      // If no row is passed, add a new one
      if (!row) {
        const newRowHtml = common.getChiefComplaintRow(); // Create a new row
        $("#chiefComplaintsContainer tbody").append(newRowHtml); // Append to the container
        row = $("#chiefComplaintsContainer .complaint-row").last(); // Select the newly added row
      }

      // Populate the row with the medicine data
      row.find(".complaint-input").val(complaints.complaint);
      row.find(".unit-select").val(complaints.unit);
      row.find(".duration-select").val(complaints.duration);
    }

    function populateAllMedicines(medicines) {
      if (medicines && medicines.length > 0) {
        // Clear existing rows before populating
        $("#medicineContainer .medicine-row").remove();

        medicines.forEach((medicine, index) => {
          // For each medicine, either populate an existing row or add a new row
          if (index === 0) {
            populateMedicineRow(medicine); // Populate the first row
          } else {
            const newRowHtml = common.getMedicineRow(); // Create a new row
            $("#medicineContainer tbody").append(newRowHtml);
            populateMedicineRow(
              medicine,
              $("#medicineContainer .medicine-row").last()
            ); // Populate the new row
          }
        });
      }
    }
    function populateMedicineRow(medicine, row) {
      // If no row is passed, add a new one
      if (!row) {
        const newRowHtml = common.getMedicineRow(); // Create a new row
        $("#medicineContainer tbody").append(newRowHtml); // Append to the container
        row = $("#medicineContainer .medicine-row").last(); // Select the newly added row
      }

      // Populate the row with the medicine data
      row.find(".medicine-input").val(medicine.medicinename);
      row.find("[id^='medicineType']").val(medicine.medicinetype);
      row
        .find("[id^='medicineType']")
        .val(medicine.medicinetype)
        .trigger("change");
      row.find("[id^='quantity']").val(medicine.quantity);
      row.find("[id^='inlineMorning']").prop("checked", medicine.morning);
      row.find("[id^='inlineAfternoon']").prop("checked", medicine.afternoon);
      row.find("[id^='inlineNight']").prop("checked", medicine.night);
      row
        .find("[id^='isPrintableOnPrescriptionCheckChecked']")
        .prop("checked", medicine.isPrintableOnPrescription);
      row.find("[id^='durationnumber']").val(medicine.durationnumber);
      row.find("[id^='slctDuration']").val(medicine.duration);
      row
        .find("[id^='isPrintableOnPrescriptionCheckChecked']")
        .prop("checked", medicine.isPrintableOnPrescription);
      row.find("[id^='moredetail']").val(medicine.moredetail);
    }

    async function populateInvestigation(
      investigations,
      investigationMoreDetail
    ) {
      $(".investigation-detail-select").val(investigationMoreDetail);
      try {
        const investigationListData =
          await window.electronAPI.getInvestigation();

        // Initialize MagicSuggest and store the instance
        const investigationSuggest = $("#investigationList").magicSuggest({
          data: investigationListData,
          placeholder: "Type or select Investigation",
        });

        if (investigations.length > 0) {
          // Find matching investigations by ID
          const investigationsToSelect = investigationListData.filter((item) =>
            investigations.includes(item.name)
          );

          // Use the MagicSuggest instance to set selection
          investigationSuggest.setSelection(investigationsToSelect);
        }
      } catch (error) {
        console.error("Error loading investigations:", error);
      }
    }
    async function populatePlan(plans) {
      try {
        const planListData = await window.electronAPI.getPlan();

        // Initialize MagicSuggest and store the instance
        const planSuggest = $("#planList").magicSuggest({
          data: planListData,
          placeholder: "Type or select Investigation",
        });

        if (plans.length > 0) {
          // Find matching plans by ID
          const planToSelect = planListData.filter((item) =>
            plans.includes(item.name)
          );

          // Use the MagicSuggest instance to set selection
          planSuggest.setSelection(planToSelect);
        }
      } catch (error) {
        console.error("Error loading plans:", error);
      }
    }

    function populateRehabilitationAids(rehabilitationAids) {
      if (rehabilitationAids && rehabilitationAids.length > 0) {
        // Clear existing rows before populating
        $("#rehabilitationAidsContainer .rehabilitation-aids-row").remove();

        rehabilitationAids.forEach((rehabilitationAid, index) => {
          // For each medicine, either populate an existing row or add a new row
          if (index === 0) {
            populateRehabilitationAidRow(rehabilitationAid); // Populate the first row
          } else {
            const newRowHtml = common.getRehabilitationAidRow(); // Create a new row
            $("#rehabilitationAidsContainer tbody").append(newRowHtml);
            populateRehabilitationAidRow(
              rehabilitationAid,
              $("#rehabilitationAidsContainer .rehabilitation-aids-row").last()
            ); // Populate the new row
          }
        });
      }
    }
    function populateRehabilitationAidRow(rehabilitationAid, row) {
      // If no row is passed, add a new one
      if (!row) {
        const newRowHtml = common.getRehabilitationAidRow(); // Create a new row
        $("#rehabilitationAidsContainer tbody").append(newRowHtml); // Append to the container
        row = $("#rehabilitationAidsContainer .rehabilitation-aids-row").last(); // Select the newly added row
      }
      // Populate the row with the medicine data
      row.find(".rehabilitation-aids-input").val(rehabilitationAid.name);
      row.find(".moredetail-input").val(rehabilitationAid.moreDetail);
    }

    function populateAllPatientInstructions(patientInstructions) {
      if (patientInstructions && patientInstructions.length > 0) {
        // Clear existing rows before populating
        $("#patient-instructionContainer .patient-instruction-row").remove();

        patientInstructions.forEach((patientInstruction, index) => {
          // For each medicine, either populate an existing row or add a new row
          if (index === 0) {
            populateAllPatientInstructionsRow(patientInstruction); // Populate the first row
          } else {
            const newRowHtml = common.getPatientInstructionRow(); // Create a new row
            $("#patient-instructionContainer tbody").append(newRowHtml);
            populateAllPatientInstructionsRow(
              patientInstruction,
              $("#patient-instructionContainer .patient-instruction-row").last()
            ); // Populate the new row
          }
        });
      }
    }
    function populateAllPatientInstructionsRow(patientInstruction, row) {
      // If no row is passed, add a new one
      if (!row) {
        const newRowHtml = common.getPatientInstructionRow(); // Create a new row
        $("#patient-instructionContainer tbody").append(newRowHtml); // Append to the container
        row = $(
          "#patient-instructionContainer .patient-instruction-row"
        ).last(); // Select the newly added row
      }
      // Populate the row with the medicine data
      row.find(".patient-instruction-input").val(patientInstruction.title);
      row.find("#textPInstDetail").val(patientInstruction.detail);
    }

    async function gettemplateData() {
      var templateData = {
        patientInformation: {
          patientname: $("#txtName").val() ? $("#txtName").val() : "",
          patientage: $("#txtAge").val() ? $("#txtAge").val() : "",
          checkupDate: $("#txtDate").val() ? $("#txtDate").val() : "",
          dm: $("#DM").hasClass("btn-success"),
          htn: $("#HTN").hasClass("btn-success"),
          cva: $("#CVA").hasClass("btn-success"),
          cad: $("#CAD").hasClass("btn-success"),
          hepatitis: $("#HEPATITIS").hasClass("btn-success"),
          trauma: $("#TRAUMA").hasClass("btn-success"),
          laminectomy: $("#laminectomyCheckChecked").prop("checked"),
          tpf: $("#tPFCheckChecked").prop("checked"),
          craniotomy: $("#craniotomyCheckChecked").prop("checked"),
          vpshunt: $("#vPshuntCheckChecked").prop("checked"),
          mmc: $("#mMCCheckChecked").prop("checked"),
          unitsurgery: $(".unit-surgery-select").val()
            ? $(".unit-surgery-select").val()
            : "",

          durationsurgery: $(".duration-surgery-select").val()
            ? $(".duration-surgery-select").val()
            : "",
          patientSurgeryFurtherDetail: $("#txtSurgeryFurtherdetails").val()
            ? $("#txtSurgeryFurtherdetails").val()
            : "",

          complaintData: getAllComplaints(),
          selectedDiagnosis: getSelectedDiagnosis(),
          selectedInvestigation: await getSelectedInvestigation(),
          investigationMoreDetail: $(".investigation-detail-select").val()
            ? $(".investigation-detail-select").val()
            : "",
          selectedPlan: await getSelectedPlan(),
          gcs: $("#gcsTxtBox").val() ? $("#gcsTxtBox").val() : "",
          bp: $("#bpTxtbox").val() ? $("#bpTxtbox").val() : "",

          powerUL1: $("#powerUL1TxtBox").val()
            ? $("#powerUL1TxtBox").val()
            : "",
          powerUL2: $("#powerUL2TxtBox").val()
            ? $("#powerUL2TxtBox").val()
            : "",
          powerLL1: $("#powerLL1TxtBox").val()
            ? $("#powerLL1TxtBox").val()
            : "",
          powerLL2: $("#powerLL2TxtBox").val()
            ? $("#powerLL2TxtBox").val()
            : "",
          sensations: $("#select-sensations").val()
            ? $("#select-sensations").val()
            : "",
          slr: $("#select-slr").val() ? $("#select-slr").val() : "",
          PHALLENSIGN: $("#PHALLENSIGNCheckChecked").prop("checked"),
          TINNELSIGN: $("#TINNELSIGNCheckChecked").prop("checked"),
          SPERLINGSIGN: $("#SPERLINGSIGNCheckChecked").prop("checked"),
          HOFFSIGN: $("#HOFFSIGNCheckChecked").prop("checked"),

          selectedMedicines: getAllMedicines(),
          selectedRehabilitationAids: getRehabilitationAids(),
          selectedPatientInstructions: getAllPatientInstructions(),
          nextFollowUpDate: $("#txtboxNextFollowUpDate").val(),
        },
      };
      return templateData;
    }
    function getAllComplaints() {
      const complaints = [];

      // Loop through each row in the table body
      document
        .querySelectorAll("#chiefComplaintsContainer .complaint-row")
        .forEach((row) => {
          const complaintInput = row.querySelector(".complaint-input").value;
          const durationSelect = row.querySelector(".duration-select").value;
          const unitSelect = row.querySelector(".unit-select").value;

          // Push the data as an object into the complaints array
          complaints.push({
            complaint: complaintInput || null,
            duration: durationSelect || null,
            unit: unitSelect || null,
          });
        });

      return complaints;
    }
    function getSelectedDiagnosis() {
      const diagnosisSuggest = $("#diagnosisList").magicSuggest();
      const selectedDiagnoses = diagnosisSuggest.getSelection();

      // Map the selected diagnoses to an array of values
      const selectedValues = selectedDiagnoses.map(
        (diagnosis) => diagnosis.name
      );

      return selectedValues;
    }
    async function getSelectedInvestigation() {
      const investigationSuggest = $("#investigationList").magicSuggest();
      let selectedInvestigations = investigationSuggest.getSelection();
      for (let i = 0; i < selectedInvestigations.length; i++) {
        if (isNaN(selectedInvestigations[i].id)) {
          const result = await window.electronAPI.addInvestigation(
            selectedInvestigations[i].name
          );
        }
      }

      const selectedValues = selectedInvestigations.map(
        (investigation) => investigation.name
      );

      return selectedValues;
    }
    async function getSelectedPlan() {
      const planSuggest = $("#planList").magicSuggest();
      let selectedPlans = planSuggest.getSelection();
      for (let i = 0; i < selectedPlans.length; i++) {
        if (isNaN(selectedPlans[i].id)) {
          const result = await window.electronAPI.addPlan(
            selectedPlans[i].name
          );
        }
      }

      const selectedValues = selectedPlans.map((plan) => plan.name);

      return selectedValues;
    }
    function getAllMedicines() {
      const medicines = [];

      $("#medicineContainer .medicine-row").each(function () {
        const medicineRow = $(this);

        // Create an object for each medicine row
        const medicine = {
          medicinename: medicineRow.find(".medicine-input").val(),
          medicinetype: medicineRow.find("[id^='medicineType']").val(),
          injType: medicineRow.find("[id^='injType']").val(),
          quantity: medicineRow.find("[id^='quantity']").val(),
          morning: medicineRow.find("[id^='inlineMorning']").is(":checked"),
          afternoon: medicineRow.find("[id^='inlineAfternoon']").is(":checked"),
          night: medicineRow.find("[id^='inlineNight']").is(":checked"),
          duration: medicineRow.find("[id^='slctDuration']").val(),
          durationnumber: medicineRow.find("[id^='durationnumber']").val(),
          isPrintableOnPrescription: medicineRow
            .find("[id^='isPrintableOnPrescriptionCheckChecked']")
            .is(":checked"),
          moredetail: medicineRow.find("[id^='moredetail']").val(),
        };

        // Add the object to the medicines array
        medicines.push(medicine);
      });

      return medicines;
    }
    function getRehabilitationAids() {
      const aidsData = [];

      // Loop through each rehabilitation-aids row
      $("#rehabilitationAidsContainer .rehabilitation-aids-row").each(
        function () {
          const rehabilitationAid = $(this)
            .find(".rehabilitation-aids-input")
            .val();
          const moreDetail = $(this).find(".moredetail-input").val();

          // Push the data to the aidsData array
          if (rehabilitationAid || moreDetail) {
            aidsData.push({
              name: rehabilitationAid,
              moreDetail: moreDetail,
            });
          }
        }
      );

      return aidsData;
    }
    function getAllPatientInstructions() {
      const patientinstructions = [];

      $("#patient-instructionContainer .patient-instruction-row").each(
        function () {
          const patientinstructionRow = $(this);

          // Create an object for each patient-instruction row
          const patientinstruction = {
            title: patientinstructionRow
              .find(".patient-instruction-input")
              .val(),
            detail: patientinstructionRow.find("[id^='textPInstDetail']").val(),
          };

          // Add the object to the patient-instructions array
          patientinstructions.push(patientinstruction);
        }
      );

      return patientinstructions;
    }
    // Trigger initialization with the ID from the modal
    const id = $("#addEditModel").data("id");
    if (id) {
      init(id);
    }
  });
</script>
