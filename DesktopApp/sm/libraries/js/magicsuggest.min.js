!function(w){"use strict";function a(e,t){let c=this,d=(t=w.extend({},t),w.extend(!0,{},{allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},ajaxJSONMode:!1,autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",tooltipField:"title",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(e){return"Please reduce your entry by "+e+" character"+(1<e?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(e){return"You cannot choose more than "+e+" item"+(1<e?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(e){return"Please type "+e+" more character"+(1<e?"s":"")},mode:"local",name:"MagicSuggest",noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},t));this.addToSelection=function(e,n){if(!d.maxSelection||u.length<d.maxSelection){let t=!1;(e=Array.isArray(e)?e:[e]).forEach(e=>{!d.allowDuplicates&&-1!==w.inArray(e[d.valueField],c.getValue())||(u.push(e),t=!0)}),!0===t&&(S._renderSelection(),this.empty(),!0!==n&&w(this).trigger("selectionchange",[this,this.getSelection()]))}e="inner"===d.selectionPosition,n=0<this.getValue().length,e=e&&n?"":d.placeholder;this.input.attr("placeholder",e)},this.clear=function(e){this.removeFromSelection(u.slice(0),e)},this.collapse=function(){!0===d.expanded&&(this.combobox.detach(),d.expanded=!1,w(this).trigger("collapse",[this]))},this.disable=function(){this.container.addClass("ms-ctn-disabled"),d.disabled=!0,c.input.attr("disabled",!0)},this.empty=function(){this.input.val("")},this.enable=function(){this.container.removeClass("ms-ctn-disabled"),d.disabled=!1,c.input.attr("disabled",!1)},this.expand=function(){!d.expanded&&(this.input.val().length>=d.minChars||0<this.combobox.children().length)&&(this.combobox.appendTo(this.container),S._processSuggestions(),d.expanded=!0,w(this).trigger("expand",[this]))},this.isDisabled=function(){return d.disabled},this.isValid=function(){var n=!1===d.required||0<u.length;return(d.vtype||d.vregex)&&w.each(u,function(e,t){n=n&&S._validateSingleItem(t[d.valueField])}),n},this.getDataUrlParams=function(){return d.dataUrlParams},this.getName=function(){return d.name},this.getSelection=function(){return u},this.getRawValue=function(){return this.stripHtml(c.input.val())},this.stripHtml=function(e){return e.replace(/(<([^>]+)>)/gi,"")},this.getValue=function(){return w.map(u,function(e){return e[d.valueField]})},this.removeFromSelection=function(e,t){Array.isArray(e)||(e=[e]);var n=!1;w.each(e,function(e,t){t=w.inArray(t[d.valueField],c.getValue());-1<t&&(u.splice(t,1),n=!0)}),!0===n&&(S._renderSelection(),!0!==t&&w(this).trigger("selectionchange",[this,this.getSelection()]),d.expandOnFocus&&c.expand(),d.expanded&&S._processSuggestions()),this.input.attr("placeholder","inner"===d.selectionPosition&&0<this.getValue().length?"":d.placeholder),this.input.css({width:"100%"})},this.getData=function(){return l},this.setData=function(e){d.data=e,S._processSuggestions()},this.setName=function(e){(d.name=e)&&(d.name+=0<e.indexOf("[]")?"":"[]"),c._valueContainer&&w.each(c._valueContainer.children(),function(e,t){t.name=d.name})},this.setSelection=function(e){this.clear(),this.addToSelection(e)},this.setValue=function(e){var s=[];w.each(e,function(e,n){var t,i=!1;w.each(l,function(e,t){if(t[d.valueField]==n)return s.push(t),!(i=!0)}),i||("object"==typeof n?s.push(n):((t={})[d.valueField]=n,t[d.displayField]=n,s.push(t)))}),0<s.length&&this.addToSelection(s)},this.setDataUrlParams=function(e){d.dataUrlParams=w.extend({},e)},this.setMaxSelection=function(e){null!==(e=e<0?null:e)&&u.length>e&&this.removeFromSelection(u.slice(e)),d.maxSelection=e};var a,u=[],r=0,n=!1,o=null,l=[],g=!1,i=8,m=9,h=13,p=16,f=17,b=27,v=32,x=38,C=40,y=188,S={_displaySuggestions:function(e){c.combobox.show(),c.combobox.empty();var t=0,n=0;if(null===o)S._renderComboItems(e),t=r*e.length;else{for(var i in o)n+=1,w("<div/>",{class:"ms-res-group",html:i}).appendTo(c.combobox),S._renderComboItems(o[i].items,!0);var s=c.combobox.find(".ms-res-group").outerHeight();t=null!==s?r*e.length+n*s:r*(e.length+n)}t<c.combobox.height()||t<=d.maxDropHeight?c.combobox.height(t):t>=c.combobox.height()&&t>d.maxDropHeight&&c.combobox.height(d.maxDropHeight),1===e.length&&!0===d.autoSelect&&c.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active"),!0===d.selectFirst&&c.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active"),0===e.length&&""!==c.getRawValue()&&(s=d.noSuggestionText.replace(/\{\{.*\}\}/,c.input.val()),S._updateHelper(s),c.collapse()),!1===d.allowFreeEntries&&(0===e.length?(w(c.input).addClass(d.invalidCls),c.combobox.hide()):w(c.input).removeClass(d.invalidCls))},_getEntriesFromStringArray:function(e){var i=[];return w.each(e,function(e,t){var n={};n[d.displayField]=n[d.valueField]=t.trim(),i.push(n)}),i},_highlightSuggestion:function(e){var n=c.input.val();if(w.each(["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"],function(e,t){n=n.replace(t,"\\"+t)}),0===n.length)return e;var t=!0===d.matchCase?"g":"gi";return e.replace(new RegExp("("+n+")(?!([^<]+)?>)",t),"<em>$1</em>")},_moveSelectedRow:function(e){var t,n,i;d.expanded||c.expand(),t=c.combobox.find(".ms-res-item:not(.ms-res-item-disabled)"),n="down"===e?t.eq(0):t.filter(":last"),0<(i=c.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length&&("down"===e?(0===(n=i.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.eq(0)),e=c.combobox.scrollTop(),c.combobox.scrollTop(0),n[0].offsetTop+n.outerHeight()>c.combobox.height()&&c.combobox.scrollTop(e+r)):(0===(n=i.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.filter(":last"),c.combobox.scrollTop(r*t.length)),n[0].offsetTop<c.combobox.scrollTop()&&c.combobox.scrollTop(c.combobox.scrollTop()-r))),t.removeClass("ms-res-item-active"),n.addClass("ms-res-item-active")},_processSuggestions:function(e){var t,n,i,e=e||d.data;if(null!==e){if("string"==typeof(e="function"==typeof e?e.call(c,c.getRawValue()):e))return w(c).trigger("beforeload",[c]),(s={})[d.queryParam]=c.input.val(),s=w.extend(s,d.dataUrlParams),n=!0,i="application/x-www-form-urlencoded",d.ajaxJSONMode&&(n=!1,i="application/json",s=JSON.stringify(s)),void w.ajax(w.extend({type:d.method,url:e,data:s,contentType:i,processData:n,beforeSend:d.beforeSend,success:function(e){t="string"==typeof e?JSON.parse(e):e,S._processSuggestions(t),w(c).trigger("load",[c,t]),S._asyncValues&&(c.setValue("string"==typeof S._asyncValues?JSON.parse(S._asyncValues):S._asyncValues),S._renderSelection(),delete S._asyncValues)},error:function(e,t,n){w(c).trigger("error",[c,e,t,n])}},d.ajaxConfig));l=0<e.length&&"string"==typeof e[0]?S._getEntriesFromStringArray(e):e[d.resultsField]||e;var s="remote"===d.mode?l:S._sortAndTrim(l);S._displaySuggestions(S._group(s))}},_render:function(e){if(c.setName(d.name),c.container=w("<div/>",{class:"ms-ctn form-control "+(d.resultAsString?"ms-as-string ":"")+d.cls+(w(e).hasClass("input-lg")?" input-lg":"")+(w(e).hasClass("input-sm")?" input-sm":"")+(!0===d.disabled?" ms-ctn-disabled":"")+(!0===d.editable?"":" ms-ctn-readonly")+(!1===d.hideTrigger?"":" ms-no-trigger"),style:d.style,id:d.id}),c.container.on("focus",_._onFocus.bind(this)),c.container.on("blur",_._onBlur.bind(this)),c.container.on("keydown",_._onKeyDown.bind(this)),c.container.on("keyup",_._onKeyUp.bind(this)),c.input=w("<input/>",w.extend({type:"text",class:!0===d.editable?"":" ms-input-readonly",readonly:!d.editable,placeholder:d.placeholder,disabled:d.disabled},d.inputCfg)),c.input.on("focus",_._onInputFocus.bind(this)),c.input.on("click",_._onInputClick.bind(this)),c.combobox=w("<div/>",{class:"ms-res-ctn dropdown-menu"}).height(d.maxDropHeight),c.combobox.on("click","div.ms-res-item",_._onComboItemSelected.bind(this)),c.combobox.on("mouseover","div.ms-res-item",_._onComboItemMouseOver.bind(this)),d.selectionContainer?(c.selectionContainer=d.selectionContainer,w(c.selectionContainer).addClass("ms-sel-ctn")):c.selectionContainer=w("<div/>",{class:"ms-sel-ctn"}),c.selectionContainer.on("click",_._onFocus.bind(this)),("inner"!==d.selectionPosition||d.selectionContainer?c.container:c.selectionContainer).append(c.input),c.helper=w("<span/>",{class:"ms-helper "+d.infoMsgCls}),S._updateHelper(),c.container.append(c.helper),w(e).replaceWith(c.container),!d.selectionContainer)switch(d.selectionPosition){case"bottom":c.selectionContainer.insertAfter(c.container),!0===d.selectionStacked&&(c.selectionContainer.width(c.container.width()),c.selectionContainer.addClass("ms-stacked"));break;case"right":c.selectionContainer.insertAfter(c.container),c.container.css("float","left");break;default:c.container.append(c.selectionContainer)}!1===d.hideTrigger&&(c.trigger=w("<div/>",{class:"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),c.trigger.on("click",_._onTriggerClick.bind(this)),c.container.append(c.trigger)),w(window).on("resize",_._onWindowResized.bind(this)),null===d.value&&null===d.data||("string"==typeof d.data?(S._asyncValues=d.value,S._processSuggestions()):(S._processSuggestions(),null!==d.value&&(c.setValue(d.value),S._renderSelection()))),w("body").on("click",function(e){var t=w(e.target).attr("class");void 0===t&&(t=""),c.container.hasClass("ms-ctn-focus")&&0===c.container.has(e.target).length&&t.indexOf("ms-res-item")<0&&t.indexOf("ms-close-btn")<0&&c.container[0]!==e.target&&_._onBlur()}),!0===d.expanded&&(d.expanded=!1,c.expand())},_renderComboItems:function(e,a){var o=this,l="";w.each(e,function(e,t){var n=null!==d.renderer?d.renderer.call(o,t):t[d.displayField],i=null!==d.disabledField&&!0===t[d.disabledField],s=null!==d.tooltipField?t[d.tooltipField]:"",i=w("<div/>",{class:"ms-res-item "+(a?"ms-res-item-grouped ":"")+(i?"ms-res-item-disabled ":"")+(e%2==1&&!0===d.useZebraStyle?"ms-res-odd":""),title:s,html:!0===d.highlight?S._highlightSuggestion(n):n,"data-json":JSON.stringify(t)});l+=w("<div/>").append(i).html()}),c.combobox.append(l),r=c.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var e,o=this,t=0,l=[],r=!0===d.resultAsString&&!n;c.selectionContainer.find(".ms-sel-item").remove(),void 0!==c._valueContainer&&c._valueContainer.remove(),w.each(u,function(e,t){var n,i=null!==d.selectionRenderer?d.selectionRenderer.call(o,t):t[d.displayField],s=S._validateSingleItem(t[d.displayField])?"":" ms-sel-invalid",a=null!==d.tooltipField?t[d.tooltipField]:"";!0==r?n=w("<div/>",{class:"ms-sel-item ms-sel-text "+d.selectionCls+s,title:a,html:i+(e===u.length-1?"":d.resultAsStringDelimiter)}).data("json",t):(n=w("<div/>",{class:"ms-sel-item "+d.selectionCls+s,title:a,html:i}).data("json",t),!1===d.disabled&&w("<span/>",{class:"ms-close-btn"}).data("json",t).prependTo(n).on("click",_._onTagTriggerClick.bind(o))),l.push(n)}),c.selectionContainer.prepend(l),c._valueContainer=w("<div/>",{style:"display: none;"}),w.each(c.getValue(),function(e,t){w("<input/>",{type:"hidden",name:d.name,value:t}).appendTo(c._valueContainer)}),c._valueContainer.appendTo(c.selectionContainer),"inner"!==d.selectionPosition||d.selectionContainer||(c.input.width(0),e=c.input.offset().left-c.selectionContainer.offset().left,(t=c.container.width()-e-42)<0&&(t=c.container.width()),c.input.width(t)),u.length===d.maxSelection?S._updateHelper(d.maxSelectionRenderer.call(this,u.length)):c.helper.hide()},_selectItem:function(e){1===d.maxSelection&&(u=[]),c.addToSelection(e.data("json")),e.removeClass("ms-res-item-active"),!1!==d.expandOnFocus&&u.length!==d.maxSelection||c.collapse(),n?(d.expandOnFocus||g)&&(S._processSuggestions(),g&&c.expand()):c.input.trigger("focus")},_sortAndTrim:function(e){var i=c.getRawValue(),s=[],n=[],a=c.getValue();return 0<i.length?w.each(e,function(e,t){var n=t[d.displayField];!(!0===d.matchCase&&-1<n.indexOf(i)||!1===d.matchCase&&-1<n.toLowerCase().indexOf(i.toLowerCase()))||!1!==d.strictSuggest&&0!==n.toLowerCase().indexOf(i.toLowerCase())||s.push(t)}):s=e,w.each(s,function(e,t){!d.allowDuplicates&&-1!==w.inArray(t[d.valueField],a)||n.push(t)}),null!==d.sortOrder&&n.sort(function(e,t){return e[d.sortOrder]<t[d.sortOrder]?"asc"===d.sortDir?-1:1:e[d.sortOrder]>t[d.sortOrder]?"asc"===d.sortDir?1:-1:0}),n=d.maxSuggestions&&0<d.maxSuggestions?n.slice(0,d.maxSuggestions):n},_group:function(e){return null!==d.groupBy&&(o={},w.each(e,function(e,t){var n=-1<d.groupBy.indexOf(".")?d.groupBy.split("."):d.groupBy,i=t[d.groupBy];if("string"!=typeof n)for(i=t;0<n.length;)i=i[n.shift()];void 0===o[i]?o[i]={title:i,items:[t]}:o[i].items.push(t)})),e},_updateHelper:function(e){c.helper.html(e),c.helper.is(":visible")||c.helper.fadeIn()},_validateSingleItem:function(e){if(null!==d.vregex&&d.vregex instanceof RegExp)return d.vregex.test(e);if(null!==d.vtype)switch(d.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(e);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(e);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(e);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(e);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(e)}return!0}},_={_onBlur:function(){var e;c.container.removeClass("ms-ctn-focus"),c.collapse(),n=!1,""!==c.getRawValue()&&!0===d.allowFreeEntries&&((e={})[d.displayField]=e[d.valueField]=c.getRawValue().trim(),c.addToSelection(e)),S._renderSelection(),!1===c.isValid()?c.container.addClass(d.invalidCls):""!==c.input.val()&&!1===d.allowFreeEntries&&(c.empty(),S._updateHelper("")),w(c).trigger("blur",[c])},_onComboItemMouseOver:function(e){e=w(e.currentTarget);e.hasClass("ms-res-item-disabled")||(c.combobox.children().removeClass("ms-res-item-active"),e.addClass("ms-res-item-active"))},_onComboItemSelected:function(e){w(e.currentTarget).hasClass("ms-res-item-disabled")||S._selectItem(w(e.currentTarget))},_onFocus:function(){c.input.trigger("focus")},_onInputClick:function(){!1===c.isDisabled()&&n&&!0===d.toggleOnClick&&(d.expanded?c.collapse():c.expand())},_onInputFocus:function(){var e;!1!==c.isDisabled()||n||(n=!0,c.container.addClass("ms-ctn-focus"),c.container.removeClass(d.invalidCls),e=c.getRawValue().length,!0===d.expandOnFocus&&c.expand(),u.length===d.maxSelection?S._updateHelper(d.maxSelectionRenderer.call(this,u.length)):e<d.minChars&&S._updateHelper(d.minCharsRenderer.call(this,d.minChars-e)),S._renderSelection(),w(c).trigger("focus",[c]))},_onKeyDown:function(e){var t=c.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),n=c.input.val();if(w(c).trigger("keydown",[c,e]),e.keyCode===m&&(!1===d.useTabKey||!0===d.useTabKey&&0===t.length&&0===c.input.val().length))_._onBlur();else switch(e.keyCode){case i:0===n.length&&0<c.getSelection().length&&"inner"===d.selectionPosition&&(u.pop(),S._renderSelection(),w(c).trigger("selectionchange",[c,c.getSelection()]),c.input.attr("placeholder","inner"===d.selectionPosition&&0<c.getValue().length?"":d.placeholder),c.input.trigger("focus"),e.preventDefault());break;case m:case b:e.preventDefault();break;case h:""===n&&!d.expanded||e.preventDefault();break;case y:!0===d.useCommaKey&&e.preventDefault();break;case f:g=!0;break;case C:e.preventDefault(),S._moveSelectedRow("down");break;case x:e.preventDefault(),S._moveSelectedRow("up");break;default:u.length===d.maxSelection&&e.preventDefault()}},_onKeyUp:function(e){var t,n=c.getRawValue(),i=0<c.input.val().trim().length&&(!d.maxEntryLength||c.input.val().trim().length<=d.maxEntryLength),s={};if(w(c).trigger("keyup",[c,e]),e.keyCode!==p&&e.keyCode!==f&&clearTimeout(a),e.keyCode===b&&d.expanded&&c.combobox.hide(),e.keyCode===m&&!1===d.useTabKey||e.keyCode>h&&e.keyCode<v)e.keyCode===f&&(g=!1);else switch(e.keyCode){case x:case C:e.preventDefault();break;case h:case m:case y:if(e.keyCode!==y||!0===d.useCommaKey){if(e.preventDefault(),!0===d.expanded&&0<(t=c.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length)return void S._selectItem(t);!0==i&&!0===d.allowFreeEntries&&(s[d.displayField]=s[d.valueField]=n.trim(),c.addToSelection(s),c.collapse(),c.input.trigger("focus"));break}default:u.length===d.maxSelection?S._updateHelper(d.maxSelectionRenderer.call(this,u.length)):n.length<d.minChars?(S._updateHelper(d.minCharsRenderer.call(this,d.minChars-n.length)),!0===d.expanded&&c.collapse()):d.maxEntryLength&&n.length>d.maxEntryLength?(S._updateHelper(d.maxEntryRenderer.call(this,n.length-d.maxEntryLength)),!0===d.expanded&&c.collapse()):(c.helper.hide(),d.minChars<=n.length&&(a=setTimeout(function(){!0===d.expanded?S._processSuggestions():c.expand()},d.typeDelay)))}},_onTagTriggerClick:function(e){c.removeFromSelection(w(e.currentTarget).data("json"))},_onTriggerClick:function(){var e;!1!==c.isDisabled()||!0===d.expandOnFocus&&u.length===d.maxSelection||(w(c).trigger("triggerclick",[c]),!0===d.expanded?c.collapse():(e=c.getRawValue().length)>=d.minChars?(c.input.trigger("focus"),c.expand()):S._updateHelper(d.minCharsRenderer.call(this,d.minChars-e)))},_onWindowResized:function(){S._renderSelection()}};null!==e&&S._render(e)}w.fn.magicSuggest=function(s){var e=w(this);return 1===e.length&&e.data("magicSuggest")?e.data("magicSuggest"):(e.each(function(e){var n,t,i=w(this);i.data("magicSuggest")||("select"===this.nodeName.toLowerCase()&&(s.data=[],s.value=[],w.each(this.children,function(e,t){t.nodeName&&"option"===t.nodeName.toLowerCase()&&(s.data.push({id:t.value,name:t.text}),w(t).attr("selected")&&s.value.push(t.value))})),n={},w.each(this.attributes,function(e,t){n[t.name]="value"===t.name&&""!==t.value?JSON.parse(t.value):t.value}),t=new a(this,w.extend([],w.fn.magicSuggest.defaults,s,n)),i.data("magicSuggest",t),t.container.data("magicSuggest",t))}),1===e.length?e.data("magicSuggest"):e)},w.fn.magicSuggest.defaults={}}(jQuery);